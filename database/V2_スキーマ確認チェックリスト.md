# ✅ v2.0スキーマ確認チェックリスト

## 📋 実行前の確認事項

### Supabase側の準備
- [ ] Supabaseアカウントにログイン済み
- [ ] プロジェクトが作成済み（または新規作成）
- [ ] SQL Editorにアクセス可能

### ファイルの確認
- [ ] `002_normalized_schema.sql` ファイルが存在
- [ ] ファイルサイズが適切（約10KB程度）
- [ ] 文字コードがUTF-8

---

## 🗂️ 作成されるテーブル一覧

### コアテーブル（必須）
1. ✅ **sites** - 候補地点の基本台帳
   - site_code（ユニーク）
   - 住所、緯度経度
   - ステータス管理

2. ✅ **grid_info** - 系統/電力系データ
   - 変電所距離
   - 空き容量
   - 接続コスト
   - automation_level

3. ✅ **geo_risk** - 地理リスク
   - 標高、勾配
   - ハザード情報
   - automation_level

4. ✅ **land_regulatory** - 法規制
   - 都市計画
   - 用途地域
   - automation_level

5. ✅ **access_physical** - 物理条件
   - 道路アクセス
   - 形状
   - automation_level

6. ✅ **economics** - 経済性
   - 用地価格
   - 工事コスト
   - automation_level

### 管理テーブル
7. ✅ **automation_sources** - 自動化ソース管理
   - API/PDF/CSV等の取得元
   - リフレッシュ管理

8. ✅ **scores** - スコア履歴
   - 総合スコア
   - 各カテゴリスコア
   - グレード（A/B/C/D/F）

9. ✅ **audit_log** - 監査ログ
   - 変更履歴
   - 誰が・いつ・何を

10. ✅ **users** - ユーザー管理
    - 既存テーブルがあればスキップ

---

## 🔍 実行後の確認項目

### テーブル構造の確認
- [ ] 全10テーブルが作成されている
- [ ] 各テーブルにUUID型のidカラムがある
- [ ] 外部キー制約が正しく設定されている

### インデックスの確認
- [ ] sites テーブルに緯度経度のインデックス
- [ ] 各テーブルに site_id のインデックス
- [ ] automation_level のインデックス

### トリガーの確認
- [ ] updated_at 自動更新トリガーが設定されている
- [ ] 全テーブルに適用されている

### 拡張機能の確認
- [ ] uuid-ossp 拡張が有効
- [ ] postgis 拡張が有効

---

## 🧪 動作確認クエリ

### 1. テーブル一覧確認
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;
```

期待される結果：10個のテーブル名が表示される

### 2. 外部キー確認
```sql
SELECT
    tc.table_name, 
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
ORDER BY tc.table_name;
```

期待される結果：各テーブルの site_id が sites.id を参照

### 3. インデックス確認
```sql
SELECT
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY tablename, indexname;
```

期待される結果：各テーブルに複数のインデックス

### 4. トリガー確認
```sql
SELECT
    trigger_name,
    event_object_table,
    action_statement
FROM information_schema.triggers
WHERE trigger_schema = 'public'
ORDER BY event_object_table;
```

期待される結果：各テーブルに update_*_updated_at トリガー

---

## 📊 サンプルデータ投入テスト

### テストシナリオ1：基本的なサイト作成
```sql
-- サイト作成
INSERT INTO sites (site_code, name, address, lat, lon, area_m2)
VALUES ('TEST-001', 'テストサイト', '東京都千代田区', 35.6812, 139.7671, 5000)
RETURNING *;

-- Grid Info追加
INSERT INTO grid_info (site_id, target_voltage_kv, automation_level)
SELECT id, 66, 'MANUAL' FROM sites WHERE site_code = 'TEST-001'
RETURNING *;

-- 結合確認
SELECT s.*, g.* 
FROM sites s 
LEFT JOIN grid_info g ON s.id = g.site_id 
WHERE s.site_code = 'TEST-001';
```

### テストシナリオ2：スコア計算
```sql
-- スコア追加
INSERT INTO scores (
    site_id, 
    score_total, 
    score_grid, 
    grade, 
    formula_version
)
SELECT 
    id, 
    85.5, 
    90.0, 
    'A', 
    'v1.0'
FROM sites WHERE site_code = 'TEST-001'
RETURNING *;

-- スコア履歴確認
SELECT 
    s.site_code,
    sc.score_total,
    sc.grade,
    sc.calculated_at
FROM sites s
JOIN scores sc ON s.id = sc.site_id
ORDER BY sc.calculated_at DESC;
```

### テストシナリオ3：監査ログ
```sql
-- 監査ログ追加
INSERT INTO audit_log (
    site_id,
    actor,
    table_name,
    field_name,
    old_value,
    new_value
)
SELECT 
    id,
    'test_user',
    'sites',
    'status',
    'draft',
    'under_review'
FROM sites WHERE site_code = 'TEST-001'
RETURNING *;

-- 監査ログ確認
SELECT 
    s.site_code,
    al.actor,
    al.table_name,
    al.field_name,
    al.old_value,
    al.new_value,
    al.changed_at
FROM sites s
JOIN audit_log al ON s.id = al.site_id
ORDER BY al.changed_at DESC;
```

---

## 🎯 成功基準

以下がすべて満たされていればOK：

1. ✅ 10個のテーブルがすべて作成されている
2. ✅ サンプルデータが正常に挿入できる
3. ✅ JOIN クエリが正常に動作する
4. ✅ updated_at が自動更新される
5. ✅ 外部キー制約が機能している
6. ✅ エラーや警告が出ていない

---

## 🚨 よくある問題と解決方法

### 問題1：PostGIS拡張がない
```sql
CREATE EXTENSION IF NOT EXISTS postgis;
```

### 問題2：UUID拡張がない
```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

### 問題3：既存テーブルとの競合
- users テーブルは `IF NOT EXISTS` で作成されるため問題なし
- 他のテーブルが既存の場合は、一度削除してから再実行

### 問題4：権限エラー
- Supabaseの管理者権限で実行していることを確認
- service_role キーを使用

---

## 📝 実行ログの保存

実行後、以下の情報を記録しておくと便利です：

```
実行日時：2025年10月5日
プロジェクト名：[あなたのプロジェクト名]
Project URL：https://xxxxx.supabase.co
実行結果：成功 / 失敗
エラー内容（あれば）：
作成されたテーブル数：10個
```

---

## 🎉 次のアクション

チェックリストがすべて完了したら：

1. ✅ 環境変数ファイル（.env）を作成
2. 🔄 v2.0 APIをローカルでテスト
3. 🚀 VPSにデプロイ
4. 📱 フロントエンド接続

---

## 📞 問題が発生した場合

1. このチェックリストを最初から確認
2. SQL Editorのエラーメッセージをコピー
3. Supabase Logsを確認（Settings → Logs）
4. 必要に応じてスキーマを再実行
