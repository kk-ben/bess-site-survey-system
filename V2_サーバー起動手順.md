# 🚀 BESS v2.0 サーバー起動とテスト手順

## 📋 準備完了状況

✅ コード修正完了  
✅ ビルド成功  
✅ 環境変数設定完了  
✅ Supabaseスキーマデプロイ完了  

---

## 🚀 ステップ1: サーバー起動

### 方法A: 起動スクリプト使用（推奨）

```powershell
cd bess-site-survey-system
.\start-server.ps1
```

### 方法B: 手動起動

```powershell
cd bess-site-survey-system
npm run dev:backend
```

### 期待される出力

```
🚀 BESS Site Survey System API running on port 3000
📊 Environment: development
🗄️  Database: Connected
🔄 Cache: Disabled
```

---

## 🧪 ステップ2: APIテスト

**別のターミナルを開いて実行：**

### 方法A: テストスクリプト使用（推奨）

```powershell
cd bess-site-survey-system
.\test-api.ps1
```

### 方法B: 手動テスト

```powershell
# v2.0 API情報取得
Invoke-RestMethod -Uri "http://localhost:3000/api/v2" -Method GET

# CSVテンプレートダウンロード
Invoke-WebRequest -Uri "http://localhost:3000/api/v2/import/template" -Method GET -OutFile "template.csv"

# サイト一覧取得（認証エラーが期待される）
Invoke-RestMethod -Uri "http://localhost:3000/api/v2/sites" -Method GET
```

---

## 📊 ステップ3: テストデータ投入

### Supabase SQL Editorで実行

```sql
-- テストサイトを作成
INSERT INTO sites (site_code, name, address, lat, lon, area_m2, status)
VALUES (
    'STB2025-000001',
    'テストサイト（東京駅）',
    '東京都千代田区丸の内1-9-1',
    35.6812,
    139.7671,
    5000,
    'draft'
) RETURNING *;

-- Grid Infoを追加
INSERT INTO grid_info (
    site_id,
    target_voltage_kv,
    substation_distance_m,
    capacity_available_mw,
    automation_level
)
SELECT 
    id,
    66,
    1500,
    10.5,
    'MANUAL'
FROM sites WHERE site_code = 'STB2025-000001'
RETURNING *;

-- Geo Riskを追加
INSERT INTO geo_risk (
    site_id,
    elevation_m,
    slope_pct,
    automation_level
)
SELECT 
    id,
    10.5,
    2.3,
    'AUTO'
FROM sites WHERE site_code = 'STB2025-000001'
RETURNING *;

-- 確認クエリ
SELECT 
    s.site_code,
    s.name,
    s.address,
    s.status,
    g.target_voltage_kv,
    g.capacity_available_mw,
    gr.elevation_m,
    gr.slope_pct
FROM sites s
LEFT JOIN grid_info g ON s.id = g.site_id
LEFT JOIN geo_risk gr ON s.id = gr.site_id
WHERE s.site_code = 'STB2025-000001';
```

---

## 🎯 ステップ4: データ取得確認

### Supabaseで直接確認

```sql
-- サイト一覧
SELECT * FROM sites ORDER BY created_at DESC LIMIT 10;

-- Grid Info
SELECT * FROM grid_info LIMIT 10;

-- Geo Risk
SELECT * FROM geo_risk LIMIT 10;
```

---

## 🐛 トラブルシューティング

### エラー: "Cannot connect to server"

**原因**: サーバーが起動していない

**解決策**:
```powershell
.\start-server.ps1
```

---

### エラー: "Port 3000 is already in use"

**原因**: ポート3000が既に使用中

**解決策**:
```powershell
# 使用中のプロセスを確認
netstat -ano | findstr :3000

# プロセスを終了
taskkill /PID [PID番号] /F

# サーバーを再起動
.\start-server.ps1
```

---

### エラー: "Database connection failed"

**原因**: Supabase接続情報が正しくない

**解決策**:
1. `.env`ファイルを確認
2. `SUPABASE_URL`と`SUPABASE_SERVICE_ROLE_KEY`を確認
3. Supabaseプロジェクトが起動しているか確認

---

### エラー: "JWT_SECRET not configured"

**原因**: JWT_SECRETが設定されていない

**解決策**:
```powershell
# .envファイルに追加
Add-Content .env "JWT_SECRET=your-super-secret-jwt-key-change-this-in-production"
```

---

## 📝 次のステップ

### 1. CSVインポートのテスト

```powershell
# CSVテンプレートをダウンロード
Invoke-WebRequest -Uri "http://localhost:3000/api/v2/import/template" -OutFile "import-template.csv"

# テンプレートを編集してデータを追加

# インポート実行（認証が必要）
$csvContent = Get-Content "import-template.csv" -Raw
$body = @{
    csv_content = $csvContent
    trigger_initial_jobs = $true
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:3000/api/v2/import/csv" `
    -Method POST `
    -ContentType "application/json" `
    -Body $body `
    -Headers @{ Authorization = "Bearer YOUR_TOKEN" }
```

### 2. 認証トークンの取得

認証機能を実装するか、開発環境では一時的に認証をスキップすることができます。

### 3. フロントエンドとの連携

フロントエンドからv2.0 APIを呼び出すように設定します。

---

## 🎊 完了！

v2.0 APIが正常に動作しています！

次は、実際のデータを投入して機能をテストしてください。

---

**作成日**: 2025年10月5日  
**バージョン**: v2.0  
**ステータス**: サーバー起動準備完了 ✅
