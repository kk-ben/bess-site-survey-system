# ğŸš€ BESS v2.0 æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œã‚¬ã‚¤ãƒ‰

## ç¾åœ¨ã®çŠ¶æ…‹
âœ… v2.0ã‚³ãƒ¼ãƒ‰ã®ãƒ“ãƒ«ãƒ‰æˆåŠŸ  
âœ… TypeScriptã‚¨ãƒ©ãƒ¼ä¿®æ­£å®Œäº†  
âœ… ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†  

## ğŸ“‹ å®Ÿè¡Œã™ã‚‹é †åº

### ã‚¹ãƒ†ãƒƒãƒ—1: Supabaseã‚¹ã‚­ãƒ¼ãƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ â±ï¸ 5åˆ†

#### 1-1. Supabaseã«ãƒ­ã‚°ã‚¤ãƒ³
```
https://supabase.com
```

#### 1-2. SQL Editorã‚’é–‹ã
1. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ â†’ ã€ŒSQL Editorã€
2. ã€ŒNew queryã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### 1-3. v2.0ã‚¹ã‚­ãƒ¼ãƒã‚’å®Ÿè¡Œ

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³A: ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæ¨å¥¨ï¼‰**
```bash
# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
bess-site-survey-system/database/migrations/002_v2_clean_install.sql
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³B: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ **
```bash
# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
bess-site-survey-system/database/migrations/002_normalized_schema.sql
```

1. ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å…¨é¸æŠï¼ˆCtrl+Aï¼‰
2. ã‚³ãƒ”ãƒ¼ï¼ˆCtrl+Cï¼‰
3. Supabase SQL Editorã«è²¼ã‚Šä»˜ã‘ï¼ˆCtrl+Vï¼‰
4. ã€ŒRunã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
5. ã€ŒSuccessã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª

#### 1-4. ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚’ç¢ºèª
å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ â†’ ã€ŒTable Editorã€ã§ä»¥ä¸‹ã‚’ç¢ºèªï¼š
- âœ… sites
- âœ… grid_info
- âœ… geo_risk
- âœ… land_regulatory
- âœ… access_physical
- âœ… economics
- âœ… automation_sources
- âœ… scores
- âœ… audit_log

---

### ã‚¹ãƒ†ãƒƒãƒ—2: ç’°å¢ƒå¤‰æ•°ã®è¨­å®š â±ï¸ 3åˆ†

#### 2-1. Supabaseæ¥ç¶šæƒ…å ±ã‚’å–å¾—

Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼š
1. Settings â†’ API
2. ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ï¼š
   - Project URL
   - anon public key
   - service_role key

#### 2-2. .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ/æ›´æ–°

```bash
# bess-site-survey-system/.env
```

ä»¥ä¸‹ã®å†…å®¹ã‚’è¿½åŠ ï¼š

```bash
# Supabaseè¨­å®š
SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›´æ¥æ¥ç¶šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.xxxxxxxxxxxxx.supabase.co:5432/postgres

# JWTè¨­å®š
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# ã‚µãƒ¼ãƒãƒ¼è¨­å®š
PORT=4000
NODE_ENV=development

# CORSè¨­å®š
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173

# Redisï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
REDIS_URL=redis://localhost:6379
```

âš ï¸ **é‡è¦**: å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„

---

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å‹•ä½œç¢ºèª â±ï¸ 5åˆ†

#### 3-1. ä¾å­˜é–¢ä¿‚ã®æœ€çµ‚ç¢ºèª
```powershell
cd bess-site-survey-system
npm install
```

#### 3-2. ãƒ“ãƒ«ãƒ‰ç¢ºèª
```powershell
npm run build:backend
```

âœ… ã‚¨ãƒ©ãƒ¼ãªãå®Œäº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèª

#### 3-3. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
```powershell
npm run dev:backend
```

ä»¥ä¸‹ã®ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKï¼š
```
ğŸš€ BESS Site Survey System API running on port 4000
ğŸ“Š Environment: development
ğŸ—„ï¸  Database: Connected
```

#### 3-4. APIãƒ†ã‚¹ãƒˆï¼ˆåˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ï¼‰

**PowerShellã§å®Ÿè¡Œï¼š**
```powershell
# v2.0 APIæƒ…å ±å–å¾—
Invoke-RestMethod -Uri "http://localhost:4000/api/v2" -Method GET

# æœŸå¾…ã•ã‚Œã‚‹çµæœï¼š
# {
#   "message": "BESS Site Survey System API v2.0",
#   "version": "2.0.0",
#   "status": "running",
#   "features": [...]
# }
```

**ã¾ãŸã¯ã€ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ï¼š**
```powershell
.\scripts\test-v2-api.ps1
```

---

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥ â±ï¸ 3åˆ†

#### 4-1. Supabase SQL Editorã§å®Ÿè¡Œ

```sql
-- ãƒ†ã‚¹ãƒˆã‚µã‚¤ãƒˆã‚’ä½œæˆ
INSERT INTO sites (site_code, name, address, lat, lon, area_m2, status)
VALUES (
    'STB2025-000001',
    'ãƒ†ã‚¹ãƒˆã‚µã‚¤ãƒˆï¼ˆæ±äº¬é§…ï¼‰',
    'æ±äº¬éƒ½åƒä»£ç”°åŒºä¸¸ã®å†…1-9-1',
    35.6812,
    139.7671,
    5000,
    'draft'
);

-- Grid Infoã‚’è¿½åŠ 
INSERT INTO grid_info (
    site_id,
    target_voltage_kv,
    substation_distance_m,
    capacity_available_mw,
    automation_level
)
SELECT 
    id,
    66,
    1500,
    10.5,
    'MANUAL'
FROM sites WHERE site_code = 'STB2025-000001';

-- ç¢ºèª
SELECT 
    s.site_code,
    s.name,
    s.address,
    g.target_voltage_kv,
    g.capacity_available_mw
FROM sites s
LEFT JOIN grid_info g ON s.id = g.site_id;
```

#### 4-2. APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ

ã¾ãšã€èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³A: ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ**
```sql
-- Supabase SQL Editorã§å®Ÿè¡Œ
INSERT INTO users (email, password_hash, role, name)
VALUES (
    'test@example.com',
    '$2b$10$abcdefghijklmnopqrstuvwxyz', -- ãƒ€ãƒŸãƒ¼ãƒãƒƒã‚·ãƒ¥
    'admin',
    'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼'
);
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³B: èªè¨¼ãªã—ã§ãƒ†ã‚¹ãƒˆï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰**

ä¸€æ™‚çš„ã«èªè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ï¼š

```typescript
// src/routes/v2/site.routes.ts
// ä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
// router.use(authMiddleware);
```

ãã®å¾Œã€APIãƒ†ã‚¹ãƒˆï¼š
```powershell
# ã‚µã‚¤ãƒˆä¸€è¦§å–å¾—
Invoke-RestMethod -Uri "http://localhost:4000/api/v2/sites" -Method GET
```

---

### ã‚¹ãƒ†ãƒƒãƒ—5: CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã®ãƒ†ã‚¹ãƒˆ â±ï¸ 5åˆ†

#### 5-1. CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
```powershell
Invoke-WebRequest -Uri "http://localhost:4000/api/v2/import/template" `
    -OutFile "test-import.csv"
```

#### 5-2. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†

`test-import.csv` ã‚’é–‹ã„ã¦ã€è¤‡æ•°è¡Œã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼š

```csv
address,lat,lon,name,area_m2,land_right_status,status,priority_rank
æ±äº¬éƒ½åƒä»£ç”°åŒºä¸¸ã®å†…1-1-1,35.681236,139.767125,ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ãƒˆ1,10000,æ‰€æœ‰,draft,A
æ±äº¬éƒ½æ¸¯åŒºå…­æœ¬æœ¨6-10-1,35.664120,139.729050,ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ãƒˆ2,8000,è³ƒè²¸,draft,B
æ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿2-8-1,35.689729,139.691706,ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ãƒˆ3,12000,æ‰€æœ‰,draft,A
```

#### 5-3. CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ

```powershell
$csvContent = Get-Content "test-import.csv" -Raw
$body = @{
    csv_content = $csvContent
    trigger_initial_jobs = $true
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:4000/api/v2/import/csv" `
    -Method POST `
    -ContentType "application/json" `
    -Body $body
```

#### 5-4. ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœã‚’ç¢ºèª

```powershell
# ã‚µã‚¤ãƒˆä¸€è¦§ã‚’å–å¾—
Invoke-RestMethod -Uri "http://localhost:4000/api/v2/sites?limit=10" -Method GET
```

---

### ã‚¹ãƒ†ãƒƒãƒ—6: VPSã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ â±ï¸ 10åˆ†

#### 6-1. VPSç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š

VPSã«SSHæ¥ç¶šã—ã¦ï¼š

```bash
cd ~/bess-site-survey-system
nano .env
```

Supabaseæ¥ç¶šæƒ…å ±ã‚’è¿½åŠ 

#### 6-2. ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ

**ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ï¼š**
```powershell
.\scripts\deploy-from-local.ps1
```

**ã¾ãŸã¯ã€VPSä¸Šã§ï¼š**
```bash
git pull origin main
npm install
npm run build
pm2 restart bess-api
```

#### 6-3. VPSä¸Šã§ã®å‹•ä½œç¢ºèª

```bash
curl http://localhost:4000/api/v2
```

---

## ğŸ¯ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

å®Ÿè¡Œã—ãŸã‚¹ãƒ†ãƒƒãƒ—ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼š

- [ ] ã‚¹ãƒ†ãƒƒãƒ—1: Supabaseã‚¹ã‚­ãƒ¼ãƒã®ãƒ‡ãƒ—ãƒ­ã‚¤
  - [ ] SQLå®Ÿè¡Œå®Œäº†
  - [ ] ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆç¢ºèª
- [ ] ã‚¹ãƒ†ãƒƒãƒ—2: ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
  - [ ] .envãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
  - [ ] Supabaseæ¥ç¶šæƒ…å ±è¨­å®š
- [ ] ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å‹•ä½œç¢ºèª
  - [ ] ãƒ“ãƒ«ãƒ‰æˆåŠŸ
  - [ ] ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æˆåŠŸ
  - [ ] APIç–é€šç¢ºèª
- [ ] ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥
  - [ ] SQLã§ãƒ‡ãƒ¼ã‚¿ä½œæˆ
  - [ ] APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
- [ ] ã‚¹ãƒ†ãƒƒãƒ—5: CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã®ãƒ†ã‚¹ãƒˆ
  - [ ] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  - [ ] ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
  - [ ] çµæœç¢ºèª
- [ ] ã‚¹ãƒ†ãƒƒãƒ—6: VPSã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  - [ ] ç’°å¢ƒå¤‰æ•°è¨­å®š
  - [ ] ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
  - [ ] å‹•ä½œç¢ºèª

---

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: "Cannot find module '@supabase/supabase-js'"
```powershell
npm install @supabase/supabase-js
```

### ã‚¨ãƒ©ãƒ¼: "Database connection failed"
- .envãƒ•ã‚¡ã‚¤ãƒ«ã®SUPABASE_URLã‚’ç¢ºèª
- Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª

### ã‚¨ãƒ©ãƒ¼: "JWT_SECRET not configured"
- .envãƒ•ã‚¡ã‚¤ãƒ«ã«JWT_SECRETã‚’è¿½åŠ 

### ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãªã„
```powershell
# ãƒãƒ¼ãƒˆ4000ãŒä½¿ç”¨ä¸­ã‹ç¢ºèª
netstat -ano | findstr :4000

# ä½¿ç”¨ä¸­ã®å ´åˆã€ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
taskkill /PID [PIDç•ªå·] /F
```

### CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå¤±æ•—ã™ã‚‹
- CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’UTF-8ã«å¤‰æ›´
- ç·¯åº¦çµŒåº¦ã®å½¢å¼ã‚’ç¢ºèªï¼ˆå°æ•°ç‚¹å½¢å¼ï¼‰
- å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆaddress, lat, lonï¼‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

---

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹çµæœ

ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå®Œäº†ã™ã‚‹ã¨ï¼š

1. âœ… Supabaseã«v2.0ã‚¹ã‚­ãƒ¼ãƒãŒä½œæˆã•ã‚Œã‚‹
2. âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã§v2.0 APIãŒå‹•ä½œã™ã‚‹
3. âœ… CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
4. âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã‚‹
5. âœ… ç›£æŸ»ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã‚‹
6. âœ… è‡ªå‹•åŒ–ãƒ¬ãƒ™ãƒ«ãŒç®¡ç†ã•ã‚Œã‚‹

---

## ğŸš€ æ¬¡ã®é–‹ç™ºã‚¿ã‚¹ã‚¯

v2.0ãŒå‹•ä½œã—ãŸã‚‰ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã§ãã¾ã™ï¼š

1. **å¤–éƒ¨APIçµ±åˆ**
   - Google Elevation API
   - Google Solar API
   - å›½åœŸåœ°ç†é™¢ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—

2. **ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯**
   - ç³»çµ±ã‚¹ã‚³ã‚¢
   - åœ°ç†ã‚¹ã‚³ã‚¢
   - ç·åˆè©•ä¾¡

3. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¯¾å¿œ**
   - v2.0 APIé€£æº
   - ç›£æŸ»ãƒ­ã‚°è¡¨ç¤º
   - è‡ªå‹•åŒ–ãƒ¬ãƒ™ãƒ«è¡¨ç¤º

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆï¼š
1. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
2. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªï¼ˆlogs/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰
3. ã“ã®ã‚¬ã‚¤ãƒ‰ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å‚ç…§
4. å¿…è¦ã«å¿œã˜ã¦é–‹ç™ºãƒãƒ¼ãƒ ã«é€£çµ¡

---

**ä½œæˆæ—¥**: 2025å¹´10æœˆ5æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v2.0  
**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ5æ—¥
