# 🚀 BESS v2.0 次のステップ実行ガイド

## 現在の状態
✅ v2.0コードのビルド成功  
✅ TypeScriptエラー修正完了  
✅ 依存パッケージインストール完了  

## 📋 実行する順序

### ステップ1: Supabaseスキーマのデプロイ ⏱️ 5分

#### 1-1. Supabaseにログイン
```
https://supabase.com
```

#### 1-2. SQL Editorを開く
1. 左サイドバー → 「SQL Editor」
2. 「New query」をクリック

#### 1-3. v2.0スキーマを実行

**オプションA: クリーンインストール（推奨）**
```bash
# ファイルを開く
bess-site-survey-system/database/migrations/002_v2_clean_install.sql
```

**オプションB: 既存データベースに追加**
```bash
# ファイルを開く
bess-site-survey-system/database/migrations/002_normalized_schema.sql
```

1. ファイルの内容を全選択（Ctrl+A）
2. コピー（Ctrl+C）
3. Supabase SQL Editorに貼り付け（Ctrl+V）
4. 「Run」ボタンをクリック
5. 「Success」メッセージを確認

#### 1-4. テーブル作成を確認
左サイドバー → 「Table Editor」で以下を確認：
- ✅ sites
- ✅ grid_info
- ✅ geo_risk
- ✅ land_regulatory
- ✅ access_physical
- ✅ economics
- ✅ automation_sources
- ✅ scores
- ✅ audit_log

---

### ステップ2: 環境変数の設定 ⏱️ 3分

#### 2-1. Supabase接続情報を取得

Supabaseダッシュボード：
1. Settings → API
2. 以下をコピー：
   - Project URL
   - anon public key
   - service_role key

#### 2-2. .envファイルを作成/更新

```bash
# bess-site-survey-system/.env
```

以下の内容を追加：

```bash
# Supabase設定
SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# データベース直接接続（オプション）
DATABASE_URL=postgresql://postgres:[PASSWORD]@db.xxxxxxxxxxxxx.supabase.co:5432/postgres

# JWT設定
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# サーバー設定
PORT=4000
NODE_ENV=development

# CORS設定
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173

# Redis（オプション）
REDIS_URL=redis://localhost:6379
```

⚠️ **重要**: 実際の値に置き換えてください

---

### ステップ3: ローカルでの動作確認 ⏱️ 5分

#### 3-1. 依存関係の最終確認
```powershell
cd bess-site-survey-system
npm install
```

#### 3-2. ビルド確認
```powershell
npm run build:backend
```

✅ エラーなく完了することを確認

#### 3-3. 開発サーバー起動
```powershell
npm run dev:backend
```

以下のログが表示されればOK：
```
🚀 BESS Site Survey System API running on port 4000
📊 Environment: development
🗄️  Database: Connected
```

#### 3-4. APIテスト（別のターミナルで）

**PowerShellで実行：**
```powershell
# v2.0 API情報取得
Invoke-RestMethod -Uri "http://localhost:4000/api/v2" -Method GET

# 期待される結果：
# {
#   "message": "BESS Site Survey System API v2.0",
#   "version": "2.0.0",
#   "status": "running",
#   "features": [...]
# }
```

**または、テストスクリプトを使用：**
```powershell
.\scripts\test-v2-api.ps1
```

---

### ステップ4: テストデータの投入 ⏱️ 3分

#### 4-1. Supabase SQL Editorで実行

```sql
-- テストサイトを作成
INSERT INTO sites (site_code, name, address, lat, lon, area_m2, status)
VALUES (
    'STB2025-000001',
    'テストサイト（東京駅）',
    '東京都千代田区丸の内1-9-1',
    35.6812,
    139.7671,
    5000,
    'draft'
);

-- Grid Infoを追加
INSERT INTO grid_info (
    site_id,
    target_voltage_kv,
    substation_distance_m,
    capacity_available_mw,
    automation_level
)
SELECT 
    id,
    66,
    1500,
    10.5,
    'MANUAL'
FROM sites WHERE site_code = 'STB2025-000001';

-- 確認
SELECT 
    s.site_code,
    s.name,
    s.address,
    g.target_voltage_kv,
    g.capacity_available_mw
FROM sites s
LEFT JOIN grid_info g ON s.id = g.site_id;
```

#### 4-2. APIからデータ取得テスト

まず、認証トークンを取得する必要があります。

**オプションA: テストユーザーを作成**
```sql
-- Supabase SQL Editorで実行
INSERT INTO users (email, password_hash, role, name)
VALUES (
    'test@example.com',
    '$2b$10$abcdefghijklmnopqrstuvwxyz', -- ダミーハッシュ
    'admin',
    'テストユーザー'
);
```

**オプションB: 認証なしでテスト（開発環境のみ）**

一時的に認証をスキップするため、以下のファイルを修正：

```typescript
// src/routes/v2/site.routes.ts
// 一時的にコメントアウト
// router.use(authMiddleware);
```

その後、APIテスト：
```powershell
# サイト一覧取得
Invoke-RestMethod -Uri "http://localhost:4000/api/v2/sites" -Method GET
```

---

### ステップ5: CSVインポートのテスト ⏱️ 5分

#### 5-1. CSVテンプレートをダウンロード
```powershell
Invoke-WebRequest -Uri "http://localhost:4000/api/v2/import/template" `
    -OutFile "test-import.csv"
```

#### 5-2. テストデータを編集

`test-import.csv` を開いて、複数行のテストデータを追加：

```csv
address,lat,lon,name,area_m2,land_right_status,status,priority_rank
東京都千代田区丸の内1-1-1,35.681236,139.767125,サンプルサイト1,10000,所有,draft,A
東京都港区六本木6-10-1,35.664120,139.729050,サンプルサイト2,8000,賃貸,draft,B
東京都新宿区西新宿2-8-1,35.689729,139.691706,サンプルサイト3,12000,所有,draft,A
```

#### 5-3. CSVインポート実行

```powershell
$csvContent = Get-Content "test-import.csv" -Raw
$body = @{
    csv_content = $csvContent
    trigger_initial_jobs = $true
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:4000/api/v2/import/csv" `
    -Method POST `
    -ContentType "application/json" `
    -Body $body
```

#### 5-4. インポート結果を確認

```powershell
# サイト一覧を取得
Invoke-RestMethod -Uri "http://localhost:4000/api/v2/sites?limit=10" -Method GET
```

---

### ステップ6: VPSへのデプロイ（オプション） ⏱️ 10分

#### 6-1. VPS環境変数を設定

VPSにSSH接続して：

```bash
cd ~/bess-site-survey-system
nano .env
```

Supabase接続情報を追加

#### 6-2. デプロイスクリプト実行

**ローカルから：**
```powershell
.\scripts\deploy-from-local.ps1
```

**または、VPS上で：**
```bash
git pull origin main
npm install
npm run build
pm2 restart bess-api
```

#### 6-3. VPS上での動作確認

```bash
curl http://localhost:4000/api/v2
```

---

## 🎯 チェックリスト

実行したステップにチェックを入れてください：

- [ ] ステップ1: Supabaseスキーマのデプロイ
  - [ ] SQL実行完了
  - [ ] テーブル作成確認
- [ ] ステップ2: 環境変数の設定
  - [ ] .envファイル作成
  - [ ] Supabase接続情報設定
- [ ] ステップ3: ローカルでの動作確認
  - [ ] ビルド成功
  - [ ] サーバー起動成功
  - [ ] API疎通確認
- [ ] ステップ4: テストデータの投入
  - [ ] SQLでデータ作成
  - [ ] APIからデータ取得
- [ ] ステップ5: CSVインポートのテスト
  - [ ] テンプレートダウンロード
  - [ ] インポート実行
  - [ ] 結果確認
- [ ] ステップ6: VPSへのデプロイ（オプション）
  - [ ] 環境変数設定
  - [ ] デプロイ実行
  - [ ] 動作確認

---

## 🐛 トラブルシューティング

### エラー: "Cannot find module '@supabase/supabase-js'"
```powershell
npm install @supabase/supabase-js
```

### エラー: "Database connection failed"
- .envファイルのSUPABASE_URLを確認
- Supabaseプロジェクトが起動しているか確認

### エラー: "JWT_SECRET not configured"
- .envファイルにJWT_SECRETを追加

### サーバーが起動しない
```powershell
# ポート4000が使用中か確認
netstat -ano | findstr :4000

# 使用中の場合、プロセスを終了
taskkill /PID [PID番号] /F
```

### CSVインポートが失敗する
- CSVファイルのエンコーディングをUTF-8に変更
- 緯度経度の形式を確認（小数点形式）
- 必須フィールド（address, lat, lon）が入力されているか確認

---

## 📊 期待される結果

すべてのステップが完了すると：

1. ✅ Supabaseにv2.0スキーマが作成される
2. ✅ ローカルでv2.0 APIが動作する
3. ✅ CSVインポートが正常に動作する
4. ✅ テストデータが正しく保存される
5. ✅ 監査ログが記録される
6. ✅ 自動化レベルが管理される

---

## 🚀 次の開発タスク

v2.0が動作したら、以下の機能を実装できます：

1. **外部API統合**
   - Google Elevation API
   - Google Solar API
   - 国土地理院ハザードマップ

2. **スコア計算ロジック**
   - 系統スコア
   - 地理スコア
   - 総合評価

3. **フロントエンド対応**
   - v2.0 API連携
   - 監査ログ表示
   - 自動化レベル表示

---

## 📞 サポート

問題が発生した場合：
1. エラーメッセージを確認
2. ログファイルを確認（logs/ディレクトリ）
3. このガイドのトラブルシューティングを参照
4. 必要に応じて開発チームに連絡

---

**作成日**: 2025年10月5日  
**バージョン**: v2.0  
**最終更新**: 2025年10月5日
