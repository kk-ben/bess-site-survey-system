# üìä „Çπ„Ç≥„Ç¢Ë®àÁÆóÂºè„Éâ„Ç≠„É•„É°„É≥„Éà

## Ê¶ÇË¶Å

BESS Site Survey System„ÅÆ„Çπ„Ç≥„Ç¢Ë®àÁÆóÂºè„ÅØ„ÄÅYAMLÂΩ¢Âºè„ÅßÂ§ñÈÉ®ÁÆ°ÁêÜ„Åï„Çå„ÄÅÁâàÁÆ°ÁêÜ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

---

## üéØ „Çπ„Ç≥„Ç¢ÊßãÊàê

### Á∑èÂêà„Çπ„Ç≥„Ç¢

```
score_total = w1 √ó score_grid 
            + w2 √ó score_geo 
            + w3 √ó score_regulatory 
            + w4 √ó score_access 
            + w5 √ó score_economics

grade = A (score_total >= 80)
        B (60 <= score_total < 80)
        C (40 <= score_total < 60)
        D (20 <= score_total < 40)
        F (score_total < 20)
```

---

## üìê „Çπ„Ç≥„Ç¢Ë®àÁÆóÂºè v1.0

### 1. Á≥ªÁµ±„Çπ„Ç≥„Ç¢Ôºàscore_gridÔºâ

**Èáç„Åø**: 30%

```yaml
score_grid:
  max_score: 100
  components:
    - name: capacity_available
      weight: 0.40
      formula:
        - condition: capacity_available_mw >= 5
          points: 40
        - condition: capacity_available_mw >= 2
          points: 30
        - condition: capacity_available_mw >= 1
          points: 20
        - condition: capacity_available_mw < 1
          points: 0
    
    - name: substation_distance
      weight: 0.40
      formula:
        - condition: substation_distance_m <= 500
          points: 40
        - condition: substation_distance_m <= 1000
          points: 30
        - condition: substation_distance_m <= 2000
          points: 20
        - condition: substation_distance_m > 2000
          points: 10
    
    - name: congestion_level
      weight: 0.20
      formula:
        - condition: congestion_level == 'low'
          points: 20
        - condition: congestion_level == 'medium'
          points: 10
        - condition: congestion_level == 'high'
          points: 0
```

**TypeScriptÂÆüË£Ö**:
```typescript
function calculateGridScore(gridInfo: GridInfo): number {
  let score = 0;
  
  // Á©∫„ÅçÂÆπÈáèÔºà40ÁÇπÔºâ
  if (gridInfo.capacity_available_mw >= 5) score += 40;
  else if (gridInfo.capacity_available_mw >= 2) score += 30;
  else if (gridInfo.capacity_available_mw >= 1) score += 20;
  
  // Â§âÈõªÊâÄË∑ùÈõ¢Ôºà40ÁÇπÔºâ
  if (gridInfo.substation_distance_m <= 500) score += 40;
  else if (gridInfo.substation_distance_m <= 1000) score += 30;
  else if (gridInfo.substation_distance_m <= 2000) score += 20;
  else score += 10;
  
  // Ê∑∑ÈõëÂ∫¶Ôºà20ÁÇπÔºâ
  if (gridInfo.congestion_level === 'low') score += 20;
  else if (gridInfo.congestion_level === 'medium') score += 10;
  
  return score;
}
```

---

### 2. Âú∞ÁêÜ„É™„Çπ„ÇØ„Çπ„Ç≥„Ç¢Ôºàscore_geoÔºâ

**Èáç„Åø**: 25%

```yaml
score_geo:
  max_score: 100
  components:
    - name: flood_risk
      weight: 0.40
      formula:
        - condition: flood_depth_class == '0.5mÊú™Ê∫Ä'
          points: 40
        - condition: flood_depth_class == '2mÊú™Ê∫Ä'
          points: 25
        - condition: flood_depth_class == '5mÊú™Ê∫Ä'
          points: 10
        - condition: flood_depth_class == '5mË∂Ö'
          points: 0
    
    - name: slope
      weight: 0.30
      formula:
        - condition: slope_pct <= 3
          points: 30
        - condition: slope_pct <= 5
          points: 20
        - condition: slope_pct <= 10
          points: 10
        - condition: slope_pct > 10
          points: 0
    
    - name: elevation
      weight: 0.20
      formula:
        - condition: elevation_m >= 10 AND elevation_m <= 100
          points: 20
        - condition: elevation_m >= 5 AND elevation_m <= 200
          points: 15
        - condition: elevation_m < 5 OR elevation_m > 200
          points: 5
    
    - name: sun_loss
      weight: 0.10
      formula:
        - condition: sun_hours_loss <= 5
          points: 10
        - condition: sun_hours_loss <= 10
          points: 7
        - condition: sun_hours_loss > 10
          points: 3
```

---

### 3. Ê≥ïË¶èÂà∂„Çπ„Ç≥„Ç¢Ôºàscore_regulatoryÔºâ

**Èáç„Åø**: 20%

```yaml
score_regulatory:
  max_score: 100
  components:
    - name: city_plan
      weight: 0.40
      formula:
        - condition: city_plan_zone == 'ÈùûÁ∑öÂºï„Åç'
          points: 40
        - condition: city_plan_zone == 'Â∏ÇË°óÂåñË™øÊï¥Âå∫Âüü' AND farmland_class == 'Ëæ≤ÊåØÈô§Â§ñ'
          points: 35
        - condition: city_plan_zone == 'Â∏ÇË°óÂåñÂå∫Âüü'
          points: 30
        - condition: city_plan_zone == 'Â∏ÇË°óÂåñË™øÊï¥Âå∫Âüü' AND farmland_class == 'ÁôΩÂú∞'
          points: 20
        - condition: farmland_class == '‰øùÂÖ®'
          points: 0
    
    - name: land_use
      weight: 0.30
      formula:
        - condition: land_use_zone == 'Â∑•Ê•≠Âú∞Âüü' OR land_use_zone == 'Â∑•Ê•≠Â∞ÇÁî®Âú∞Âüü'
          points: 30
        - condition: land_use_zone == 'Ê∫ñÂ∑•Ê•≠Âú∞Âüü'
          points: 25
        - condition: land_use_zone == 'ÁÑ°ÊåáÂÆö'
          points: 20
        - condition: land_use_zone LIKE '%‰ΩèÂ±Ö%'
          points: 10
    
    - name: restrictions
      weight: 0.30
      formula:
        - condition: cultural_env_zone IS NULL AND park_landscape_zone IS NULL
          points: 30
        - condition: cultural_env_zone IS NOT NULL OR park_landscape_zone IS NOT NULL
          points: 15
        - condition: local_ordinances LIKE '%Á¶ÅÊ≠¢%'
          points: 0
```

---

### 4. „Ç¢„ÇØ„Çª„Çπ„Çπ„Ç≥„Ç¢Ôºàscore_accessÔºâ

**Èáç„Åø**: 15%

```yaml
score_access:
  max_score: 100
  components:
    - name: road_width
      weight: 0.50
      formula:
        - condition: nearest_road_width_m >= 6
          points: 50
        - condition: nearest_road_width_m >= 4
          points: 40
        - condition: nearest_road_width_m >= 3
          points: 25
        - condition: nearest_road_width_m < 3
          points: 10
    
    - name: parcel_shape
      weight: 0.30
      formula:
        - condition: parcel_shape == 'Èï∑ÊñπÂΩ¢'
          points: 30
        - condition: parcel_shape == 'Ê≠£ÊñπÂΩ¢'
          points: 25
        - condition: parcel_shape == 'Âè∞ÂΩ¢'
          points: 15
        - condition: parcel_shape == '‰∏çÊï¥ÂΩ¢'
          points: 5
    
    - name: clearance
      weight: 0.20
      formula:
        - condition: MIN(neighbor_clearance_*) >= 10
          points: 20
        - condition: MIN(neighbor_clearance_*) >= 5
          points: 15
        - condition: MIN(neighbor_clearance_*) >= 2
          points: 10
        - condition: MIN(neighbor_clearance_*) < 2
          points: 0
```

---

### 5. ÁµåÊ∏àÊÄß„Çπ„Ç≥„Ç¢Ôºàscore_economicsÔºâ

**Èáç„Åø**: 10%

```yaml
score_economics:
  max_score: 100
  components:
    - name: land_cost
      weight: 0.40
      formula:
        - condition: land_price_jpy_per_m2 <= 5000
          points: 40
        - condition: land_price_jpy_per_m2 <= 10000
          points: 30
        - condition: land_price_jpy_per_m2 <= 20000
          points: 20
        - condition: land_price_jpy_per_m2 > 20000
          points: 10
    
    - name: connection_cost
      weight: 0.30
      formula:
        - condition: connection_cost_jpy <= 50000000
          points: 30
        - condition: connection_cost_jpy <= 100000000
          points: 20
        - condition: connection_cost_jpy <= 200000000
          points: 10
        - condition: connection_cost_jpy > 200000000
          points: 0
    
    - name: construction_cost
      weight: 0.30
      formula:
        - condition: construction_cost_estimate_jpy <= 100000000
          points: 30
        - condition: construction_cost_estimate_jpy <= 200000000
          points: 20
        - condition: construction_cost_estimate_jpy <= 300000000
          points: 10
        - condition: construction_cost_estimate_jpy > 300000000
          points: 0
```

---

## üîÑ ÁâàÁÆ°ÁêÜ

### „Çπ„Ç≥„Ç¢Âºè„Éï„Ç°„Ç§„É´

```yaml
# config/scoring/formula-v1.0.yaml
version: "1.0"
created_at: "2025-01-01"
description: "ÂàùÊúü„Çπ„Ç≥„Ç¢Ë®àÁÆóÂºè"

weights:
  grid: 0.30
  geo: 0.25
  regulatory: 0.20
  access: 0.15
  economics: 0.10

grid_formula:
  # ... ‰∏äË®ò„ÅÆÂÆöÁæ©

geo_formula:
  # ... ‰∏äË®ò„ÅÆÂÆöÁæ©

# ... ‰ªñ„ÅÆ„Çπ„Ç≥„Ç¢Âºè
```

### Áâà„ÅÆÂàá„ÇäÊõø„Åà

```typescript
// src/services/scoring.service.ts
export class ScoringService {
  async calculateScore(siteId: string, formulaVersion: string = 'v1.0') {
    // „Çπ„Ç≥„Ç¢Âºè„ÇíË™≠„ÅøËæº„Åø
    const formula = await this.loadFormula(formulaVersion);
    
    // „Éá„Éº„ÇøÂèñÂæó
    const site = await sitesRepo.findById(siteId);
    const gridInfo = await gridInfoRepo.findBySiteId(siteId);
    const geoRisk = await geoRiskRepo.findBySiteId(siteId);
    // ...
    
    // „Çπ„Ç≥„Ç¢Ë®àÁÆó
    const scoreGrid = this.calculateGridScore(gridInfo, formula.grid_formula);
    const scoreGeo = this.calculateGeoScore(geoRisk, formula.geo_formula);
    // ...
    
    const scoreTotal = 
      formula.weights.grid * scoreGrid +
      formula.weights.geo * scoreGeo +
      formula.weights.regulatory * scoreRegulatory +
      formula.weights.access * scoreAccess +
      formula.weights.economics * scoreEconomics;
    
    const grade = this.calculateGrade(scoreTotal);
    
    // ‰øùÂ≠ò
    await scoresRepo.create({
      site_id: siteId,
      score_total: scoreTotal,
      score_grid: scoreGrid,
      score_geo: scoreGeo,
      score_regulatory: scoreRegulatory,
      score_access: scoreAccess,
      score_economics: scoreEconomics,
      grade,
      formula_version: formulaVersion,
      calculated_at: new Date()
    });
    
    return { scoreTotal, grade };
  }
}
```

---

## üìà „Çπ„Ç≥„Ç¢Â±•Ê≠¥

### Â±•Ê≠¥ÁÆ°ÁêÜ

```sql
-- „Çπ„Ç≥„Ç¢Â±•Ê≠¥„ÇíÁ¢∫Ë™ç
SELECT 
  calculated_at,
  formula_version,
  score_total,
  grade
FROM scores
WHERE site_id = 'xxx'
ORDER BY calculated_at DESC;
```

### ÂÜçË®àÁÆó

```typescript
// GUI„Åã„ÇâÂÜçË®àÁÆó
async function recalculateAllScores(formulaVersion: string) {
  const sites = await sitesRepo.findAll();
  
  for (const site of sites) {
    await scoringService.calculateScore(site.id, formulaVersion);
  }
}
```

---

## üé® GUIË°®Á§∫

### „Çπ„Ç≥„Ç¢Ë°®Á§∫

```tsx
// src/components/ScoreCard.tsx
export const ScoreCard = ({ score }: { score: Score }) => {
  return (
    <div className="score-card">
      <div className="grade-badge grade-{score.grade}">
        {score.grade}
      </div>
      <div className="score-total">{score.score_total.toFixed(1)}</div>
      
      <div className="score-breakdown">
        <ScoreBar label="Á≥ªÁµ±" score={score.score_grid} max={100} />
        <ScoreBar label="Âú∞ÁêÜ" score={score.score_geo} max={100} />
        <ScoreBar label="Ê≥ïË¶èÂà∂" score={score.score_regulatory} max={100} />
        <ScoreBar label="„Ç¢„ÇØ„Çª„Çπ" score={score.score_access} max={100} />
        <ScoreBar label="ÁµåÊ∏àÊÄß" score={score.score_economics} max={100} />
      </div>
      
      <div className="formula-version">
        Ë®àÁÆóÂºè: {score.formula_version}
      </div>
    </div>
  );
};
```

---

## üîó Èñ¢ÈÄ£„Éâ„Ç≠„É•„É°„É≥„Éà

- [„Éá„Éº„Çø„Éô„Éº„Çπ„Çπ„Ç≠„Éº„Éû](../database/SCHEMA_DESIGN_V2.md)
- [Ëá™ÂãïÂåñ„É≠„Ç∏„ÉÉ„ÇØ](./AUTOMATION_LOGIC.md)
- [API‰ªïÊßò](./API_SPECIFICATION.md)
